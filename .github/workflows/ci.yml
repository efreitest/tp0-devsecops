
# Nom du workflow (affichÃ© dans l'interface GitHub)
name: CI Pipeline

# DÃ©clencheurs : quand ce workflow doit s'exÃ©cuter ?
on:
  # Ã€ chaque push sur n'importe quelle branche
  push:
    branches: ['*']
  
  # Ã€ chaque pull request vers main
  pull_request:
    branches: [main]
  
  # Permet de lancer manuellement depuis l'interface GitHub
  workflow_dispatch:

# DÃ©finition des jobs (tÃ¢ches Ã  exÃ©cuter)
jobs:
  
  # ============================================
  # JOB 1 : BUILD - Installer les dÃ©pendances
  # ============================================
  build:
    # Machine virtuelle sur laquelle exÃ©cuter
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©rer le code source
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Ã‰tape 2 : Installer Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Met en cache les dÃ©pendances npm
      
      # Ã‰tape 3 : Installer les dÃ©pendances
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      # Ã‰tape 4 : Sauvegarder pour les jobs suivants
      - name: ğŸ’¾ Cache build
        uses: actions/cache@v4
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

  # ============================================
  # JOB 2 : TEST - ExÃ©cuter les tests
  # ============================================
  test:
    # Ce job a besoin que "build" soit terminÃ©
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Restaurer le cache des dÃ©pendances
      - name: ğŸ“‚ Restore cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      
      # Installer si le cache n'existe pas
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      # ExÃ©cuter les tests
      - name: ğŸ§ª Run tests
        run: npm test
      
      # Afficher un message de succÃ¨s
      - name: âœ… Tests passed
        run: echo "All tests passed successfully!"

  # ============================================
  # JOB 3 : DOCKER - Construire l'image
  # ============================================
  docker:
    # Ce job a besoin que "test" soit terminÃ©
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Construire l'image Docker
      - name: ğŸ³ Build Docker image
        run: |
          docker build -t tp0-devsecops:${{ github.sha }} .
          docker build -t tp0-devsecops:latest .
      
      # VÃ©rifier que l'image existe
      - name: ğŸ” Verify image
        run: docker images tp0-devsecops
      
      # Tester que le container dÃ©marre correctement
      - name: ğŸ§ª Test container
        run: |
          # DÃ©marrer le container
          docker run -d -p 3000:3000 --name test-container tp0-devsecops:latest
          
          # Attendre que l'app dÃ©marre
          sleep 5
          
          # Tester l'endpoint health
          curl --fail http://localhost:3000/health
          
          # Nettoyer
          docker stop test-container
          docker rm test-container
      
      - name: âœ… Docker build successful
        run: echo "Docker image built and tested successfully!"

  # ============================================
  # JOB 4 : SUMMARY - RÃ©sumÃ© final
  # ============================================
  summary:
    needs: [build, test, docker]
    runs-on: ubuntu-latest
    if: always()  # S'exÃ©cute mÃªme si les jobs prÃ©cÃ©dents Ã©chouent
    
    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "================================"
          echo "       PIPELINE SUMMARY         "
          echo "================================"
          echo "Build:  ${{ needs.build.result }}"
          echo "Test:   ${{ needs.test.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "================================"
