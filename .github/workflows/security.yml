name: Security Scan

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  # Permet de lancer manuellement
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ===========================================
  # JOB 1 : GÃ©nÃ©rer le SBOM
  # ===========================================
  sbom:
    name: ðŸ“¦ Generate SBOM
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: ðŸ“‹ Generate SBOM (CycloneDX)
        run: syft . -o cyclonedx-json > sbom.json

      - name: ðŸ“¤ Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # ===========================================
  # JOB 2 : Scanner avec Grype
  # ===========================================
  grype-scan:
    name: ðŸ” Grype Vulnerability Scan
    needs: sbom
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: ðŸ”§ Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: ðŸ” Scan vulnerabilities
        run: grype sbom:sbom.json -o table

      - name: ðŸ“Š Generate JSON report
        run: grype sbom:sbom.json -o json > grype-results.json

      - name: ðŸ“¤ Upload Grype results
        uses: actions/upload-artifact@v4
        with:
          name: grype-results
          path: grype-results.json

      # Quality Gate : Ã©choue si vulnÃ©rabilitÃ©s CRITICAL
      - name: ðŸš¨ Check for Critical vulnerabilities
        run: |
          CRITICAL=$(cat grype-results.json | jq '[.matches[] | select(.vulnerability.severity=="Critical")] | length')
          echo "Critical vulnerabilities: $CRITICAL"
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found!"
            exit 1
          fi
          echo "âœ… No critical vulnerabilities"

  # ===========================================
  # JOB 3 : Scanner avec Trivy
  # ===========================================
  trivy-scan:
    name: ðŸ›¡ï¸ Trivy Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'

      - name: ðŸ›¡ï¸ Run Trivy (SARIF output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================
  # JOB 4 : RÃ©sumÃ©
  # ===========================================
  summary:
    name: ðŸ“Š Security Summary
    needs: [sbom, grype-scan, trivy-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Grype Scan | ${{ needs.grype-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Scan | ${{ needs.trivy-scan.result }} |" >> $GITHUB_STEP_SUMMARY
